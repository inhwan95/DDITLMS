<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:fragment="toDoListFragment">
    <link rel="stylesheet" th:href="@{/static/css/todo.css}">
    <div class="card">
        <div class="card-header">
            <h5>To-Do</h5>
        </div>
        <div class="card-body pt-0">
            <div class="todo">
                <div class="todo-list-wrapper">
                    <div class="todo-list-container">
                        <div class="todo-list-body">
                            <ul id="todo-list">
                            </ul>
                        </div>
                        <div class="todo-list-footer">
                            <div class="add-task-btn-wrapper"><span class="add-task-btn">
                                    <button class="btn btn-primary"><i class="icon-plus"></i>추가하기</button></span></div>
                            <div class="new-task-wrapper">
                                <textarea id="new-task" placeholder="할일을 적어주세요"></textarea><span class="btn btn-danger cancel-btn" id="close-task-panel">닫기</span><span class="btn btn-success ms-3 add-new-task-btn" id="add-task">추가하기</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notification-popup hide">
                    <p><span class="task"></span><span class="notification-text"></span></p>
                </div>
            </div>
            <!-- HTML Template for tasks-->
            <script id="task-template" type="tect/template">
                <li class="task">
                    <div class="task-container">
                        <h4 class="task-label"></h4>
                        <span class="task-action-btn">
                          <span class="action-box large delete-btn" title="Delete Task">
                          <i class="icon"><i class="icon-trash"></i></i>
                          </span>
                          <span class="action-box large complete-btn" title="Mark Complete">
                          <i class="icon"><i class="icon-check"></i></i>
                          </span>
                          </span>
                    </div>
                </li>
            </script>
        </div>
    </div>
    <script th:src="@{/static/js/todo.js}"></script>
    <script>
        $(function (){
            $.ajax({
                url: "/getTodo",
                method: "Post",
                dataType: "json",
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                }
            })
            .done(function(fragment){
                const todoUl = document.querySelector("#todo-list")
                const todoList = fragment.todoList;
                console.log(fragment);
                todoList.forEach(todo=>{
                    console.log(todo);
                    const todoLi = document.createElement("li");
                    todoLi.classList.add("task");
                    if(todo.status == "DONE"){
                        todoLi.classList.add("completed");
                    }
                    todoLi.innerHTML = `
                        <div class="task-container">
                            <h4 class="task-label">${todo.content}</h4>
                            <span class="task-action-btn"><span onclick="deleteTask(${todo.id})" class="action-box large delete-btn" title="Delete Task"><i class="icon"><i class="icon-trash"></i></i></span><span onclick="updateTask(${todo.id})" class="action-box large complete-btn" title="Mark Complete"><i class="icon"><i class="icon-check"></i></i></span></span>
                        </div>`;
                    todoUl.prepend(todoLi);
                });
            });
        });
        function deleteTask(id){
            $.ajax({
                url: "/deleteTodo",
                data : {
                    id : id
                },
                method: "Post",
                dataType: "json",
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                }
            })
        }
        function updateTask(id){
            $.ajax({
                url: "/updateTodo",
                data : {
                    id : id
                },
                method: "Post",
                dataType: "json",
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                }
            })
        }
        const newTaskContent = document.querySelector("#new-task");
        const addNewTaskBtn = document.querySelector(".add-new-task-btn");
        newTaskContent.addEventListener("keydown",function (){
            if(event.keyCode != 13){
                return;
            }
            saveTodo();
        });
        addNewTaskBtn.addEventListener("click",function (){
            saveTodo();
        });
        function saveTodo(){
            $.ajax({
                url: "/saveTodo",
                data : {
                    content : newTaskContent.value
                },
                method: "Post",
                dataType: "json",
                beforeSend: function (xhr){
                    xhr.setRequestHeader(header,token);
                }
            })
        }
    </script>
</th:block>
</html>